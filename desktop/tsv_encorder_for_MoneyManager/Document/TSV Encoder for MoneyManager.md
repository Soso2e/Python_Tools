# TSVエンコーダー
## 制作仕様書

## 1. 概要
PayPay から出力した履歴 CSV を、家計簿ソフト「らくな家計簿」にインポート可能な TSV 形式へ変換するツール。

- 対象 OS: macOS（将来的に Windows も想定）UTF-8を想定。
- 起動方法: `.command`（macOS）、`.bat`（Windows）から Python スクリプトを起動
- 主な機能:
	- CSV ファイル読み込み（ファイル選択 / ドラッグ＆ドロップ）
	- YAML プリセットに基づく変換処理
	- 店舗名 → カテゴリの自動マッピング
	- 不明店舗の検出 ＋ YAML への追記（将来的に PopUp で対応）
	- 変換結果を TSV で出力
	- ログビューアでエラーのみ表示

---

## 2. ファイル構成

同一ディレクトリに以下の Python ファイルを配置する想定。

- `main.py`
	- エントリーポイント。起動時に UI を立ち上げるだけ。

- `ui_app.py`（UI処理）
	- Tkinter を使った GUI 実装。
	- ファイル選択 / プリセット選択 / 検証 / 変換 / ログ表示など。

- `preset_manager.py`（Yaml管理）
	- YAML プリセットの読み書き。
	- 店舗名辞書の管理。
	- 不明店舗の検出（UI からも使用）。

- `table_transformer.py`（行と列の整理整頓）
	- 行削除・列削除・列の並び替えなど、“形を整える” 処理。
	- `value_filler.py`（穴埋め処理）
	- 支払元（PayPay / カード）やカテゴリなど、セルの中身を埋める処理。

---

## 3. 動作フロー

1. `.command` or `.bat` を実行
2. `main.py` が起動し、`ui_app.py` の `run_app()` を呼び出す  
3. UI 上で行える操作:
    - **変換元ファイルの指定**
        - ファイル選択ダイアログ
		- ドラッグ＆ドロップ（ウィンドウに CSV を投げる）  
    - **プリセットの選択**  
        - YAML ファイルを選択
	    - 辞書登録や処理方法などを保持
    - **「検証」ボタン**
        - CSV 読み込み
      - プリセット読み込み
        - `preset_manager.validate_unknown_stores()` で辞書未登録の店舗名を抽出
        - ログ欄に一覧表示
        - PopUp で該当の未登録店舗を全て　新規登録 → YAML に追記
    - **「TSV変換」ボタン**
        - 不備がなさそうな場合、変換処理を実行
        - 辞書にない場合、動作しない。
4. 変換処理（`table_transformer` + `value_filler`）が動作
5. TSV を生成し、元ファイルと同じディレクトリに出力  6. ログビューアにエラーだけ表示

---

## 4. モジュール仕様 

### 4.1 `main.py`（エントリーポイント）

- アプリ起動のみを担当。  
  
---  
  
### 4.2 `ui_app.py`（UI処理）  
  
**主な責務**  

- Tkinter UI 構築
- ファイル選択、プリセット選択
- 検証 / 変換ボタン操作
- ウインドウ内にテキストエリアを用意し、ログビューア表示
- ドラッグ＆ドロップ対応（将来追加）  
  
---  
  
### 4.3 `preset_manager.py`（YAML管理）  
  
**主な責務**  
  
- YAML の読み書き  
- 店舗名辞書の管理  
- 未登録店舗の検証  
  
**構造**  
  ```
  Preset:  
  name: str  store_mapping: Dict[str, str]```  
  ```

  
---  
  
### 4.4 `table_transformer.py`（行と列の整理整頓）  
  
**処理内容**
```変換前ヘッダー
A : 取引日
B : 出金金額（円）
C : 入金金額（円）
D : 海外出金金額
E : 通貨
F : 変換レート（円）
G : 利用国
H : 取引内容
I : 取引先
J : 取引方法
K : 支払い区分
L : 利用者
M : 取引番号
```
  
1. 行削除
	- H列に「獲得」という文字が入っている行は削除
2. 列削除（E, F, G, K, L, M を削除し空欄に。）
3. B, C, D 列から金額と収支区分を決定
	- BまたはDに数字がはいっている行は、G列（収入/支出）に”支出”
	- Cに数字が入っている行は、G列（収入/支出）に”収入”
4. B列の金額を F列へ移動
5. I列 → E列へ移動

---

### 4.5 `value_filler.py`（穴埋め処理）  

**処理内容**  
- 支払元（PayPay / カード）判定
  - 資産は「PayPay」または「カード」の二択とする
  - 判定は J列（取引方法）の文字列を用い、「カード」「クレジット」などを含む場合は「カード」、それ以外は「PayPay」とする
- 店舗名 → カテゴリ穴埋め（YAML辞書）  
- 未登録店舗はログに記録（PopUpで登録予定）
- ヘッダーを下記に変更
```変更後ヘッダー
A : 日付
B : 資産
C : 分類
D : 小分類
E : 内容
F : 金額
G : 収入/支出
```

---

## 5. TSV 出力仕様
  
- 出力先: 変換元と同じディレクトリ  
- ファイル名: `元ファイル名_yy-mm-dd-hh-mm.tsv`  
- 区切り文字: TSV（タブ）  
- 文字コード: UTF-8  
- 日付：YYYY/MM/DD
  
---  
  
## 6. ログ仕様  
  
- 基本は **エラーのみ表示**
- 不明店舗、金額パースエラー、列不足など
- 成功時：
- 「エラーはありませんでした。」
- 出力先を表示
- ERROR: 変換中断（未登録店舗、必須列欠落、金額不正） 
- WARNING: 変換は継続（任意列欠落、軽微な補正）
---  
  
## 7. 今後の拡張予定
- None